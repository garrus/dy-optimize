# xhprof 性能数据分析（P1）

## 目标
发现 1+N 问题，即多次反复调用 redis/mysql/rpc 等服务。（通过聚合请求来进行优化，提高性能）

## 数据处理步骤

### 请求归类
根据记录的 Request Info 对请求进行聚类。需要人工标记。聚类后记为请求R。

### 统计请求基本数据
* 次数（单位时间内）
* run time 分布
* cpu time 分布

### 收集事件
1. 标记对 redis/mysql/rpc 服务的调用函数，并设置调用路径长度的阈值、调用路径重复次数的阈值
2. 检索反复调用的地方
3. 沿调用链向上筛查，发现 1:N 的节点
4. 将 节点->标记 的部分作为一个事件
5. 记录此事件的下列信息：
   * 时间
   * 请求R
   * 当次请求 run time 在该请求所对应的 run time 分布中的位置（top N%）
   * 档次请求 cpu time 在该请求所对应的 cpu time 分布中的位置（top N%）
   * 事件 run time 的消耗
   * 事件 run time 占当次请求的比例
   * 事件 cpu time 的消耗
   * 事件 cpu time 占当次请求的比例
   * 事件所对应的调用路径
   * 调用路径被重复的次数
   * 调用路径上游的调用次数
   
### 事件路径函数
记录出现在事件路径中的函数与请求的关系。
允许按函数来查询受影响的请求。

## 统计纬度
* 事件A 出现于 请求R 中的频率。频率越大越重要。
* 事件A 出现于 请求R 中时的资源消耗占比 对 请求R资源消耗 的斜率。斜率越大，对事件A的优化产生的效果越明显
* 函数F 出现于 事件A 中时所对应的 请求R。可以按函数来查询受影响的请求和影响面。

## 查询
* 按请求R 查询 自身的次数，资源消耗分布，发生的事件，以及每个事件 的函数路径、资源消耗占比斜率
* 按函数F 查询 所涉及的请求，以及所在事件对应的资源消耗占比斜率
* 按事件A 查询 所涉及的请求，以及对应的资源消耗占比斜率# dy-optimize
